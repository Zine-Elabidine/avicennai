{
    "action_type": "agent",
    "agent_name": "detection_engineer", 
    "answer_mode": "stream",
    "prompt": "",
    "additional_params": {
        "rule_type": "query",
        "current_rule": "title: Suspicious Lateral Movement Activity\nuuid: f8e7d6c5-b4a3-2109-fedc-ba9876543210\nseverity: high\nversion: 1.0\neffort_level: intermediate\nconfidence: medium\nmaturity: development\nenabled: true\nlearning_mode: false\ncapabilities:\n  - 'T1021 - Remote Services'\n  - 'T1078 - Valid Accounts'\nauthor: AI Author\ncreation_date: '2024/07/10'\nupdated_date: '2024/07/10'\ndescription: This rule aims to detect suspicious activities indicative of lateral movement within the network. This could include unusual remote logins, service creations, or process executions from one host to another, potentially leveraging compromised credentials or vulnerabilities to expand an attacker's foothold.\ntags:\n  - 'lateral movement'\n  - 'attack'\n  - 'security'\nfalse_positives: May occur with legitimate administrative activities, automated scripts, or misconfigured applications that perform remote operations.\nrisk_score: 80\nstatus: experimental\n\ndetection:\n  type: query\n  frequency: 15m\n  depth: 1h\n  timestamp_override: 'event.ingested'\n  integration:\n    - windows\n  indices:\n    - winlogbeat-*\n  query: 'event.code:4624 AND winlog.event_data.LogonType:(3 OR 10) AND source.ip:* AND NOT source.ip:(127.0.0.1 OR \"::1\")'\n  group_match:\n    - host.name\n    - source.ip\n    - user.name\n  lifetime: 1h\n\ninvestigations:\n  source_ip_activity:\n    type: query\n    query: 'source.ip:{{ hit_context[\"source.ip\"] }} AND NOT event.code:4624'\n    description: \"Other activities observed from the source IP address {{ hit_context['source.ip'] }}:\"\n    per_hit_description: \"- Event Code: {{ investigation['hit']['event.code'] }} | User: {{ investigation['hit']['user.name'] }} | Target Host: {{ investigation['hit']['host.name'] }} | Timestamp: {{ investigation['hit']['@timestamp'] }}\"\n    fallback: \"No other significant activities observed from source IP {{ hit_context['source.ip'] }}.\"\n    depth: 1h\n    indices:\n      - winlogbeat-*\n    group_match:\n      - event.code\n      - user.name\n      - host.name\n  user_account_logons:\n    type: query\n    query: 'event.code:4624 AND user.name:{{ hit_context[\"user.name\"] }} AND NOT (source.ip:{{ hit_context[\"source.ip\"] }} AND host.name:{{ hit_context[\"host.name\"] }})'\n    description: \"Other successful logons by user {{ hit_context['user.name'] }}:\"\n    per_hit_description: \"- Logon Type: {{ investigation['hit']['winlog.event_data.LogonType'] }} | Source IP: {{ investigation['hit']['source.ip'] }} | Target Host: {{ investigation['hit']['host.name'] }} | Timestamp: {{ investigation['hit']['@timestamp'] }}\"\n    fallback: \"No other successful logons observed for user {{ hit_context['user.name'] }}.\"\n    depth: 1h\n    indices:\n      - winlogbeat-*\n    group_match:\n      - source.ip\n      - host.name\n      - winlog.event_data.LogonType\n\nplaybook:\n  - name: set_default_risk_score\n    type: processor\n    params:\n      type: set\n      scope: 'hit_context'\n      field: 'risk_score'\n      value: \"{{rule_context['risk_score']}}\"\n    mode: single\n    description: \"Sets the default risk score for the detection event based on rule context.\"\n  - name: create_grouped_thehive_ticket\n    type: thehive_soc\n    params:\n      title: \"Lateral Movement Detected: {{grouped_hits_context[0]['user.name']}} from {{grouped_hits_context[0]['source.ip']}} to {{grouped_hits_context[0]['host.name']}}\"\n      description: |\n        ### Suspicious Lateral Movement Activity Detected\n\n        This alert indicates potential lateral movement within the network, specifically a suspicious successful logon.\n\n        **Initial Event Details (First Hit in Group):**\n        - **User:** `{{grouped_hits_context[0]['user.name']}}`\n        - **Source IP:** `{{grouped_hits_context[0]['source.ip']}}`\n        - **Target Host:** `{{grouped_hits_context[0]['host.name']}}`\n        - **Logon Type:** `{{grouped_hits_context[0]['winlog.event_data.LogonType']}}`\n        - **Timestamp:** `{{grouped_hits_context[0]['@timestamp']}}`\n\n        **Grouped Events:**\n        This alert was triggered by `{{g_playbook['count_of_hits']['value']}}` related events.\n\n        **Investigation Results:**\n\n        #### Other Activities from Source IP ({{grouped_hits_context[0]['source.ip']}}):\n        {{investigations['source_ip_activity']['report']}}\n\n        #### Other Logons by User ({{grouped_hits_context[0]['user.name']}}):\n        {{investigations['user_account_logons']['report']}}\n\n        **Rule Description:**\n        {{rule_context['description']}}\n      tlp: 3\n      pap: 3\n      severity: \"{{rule_context['risk_score']}}\"\n      flag: True\n      tags:\n        - \"XDR\"\n        - \"lateral-movement\"\n        - \"windows\"\n        - \"T1021\"\n        - \"T1078\"\n        - \"{{rule_context['severity']}}\"\n    mode: group\n    description: \"Creates a grouped TheHive ticket for lateral movement detections, including investigation results.\"",
        "prompt_type": "update",
        "history": [
            {
                "role": "user", 
                "content": "Create a detection rule for lateral movement"
            },
            {
                "role": "assistant", 
                "content": "I created a lateral movement detection rule for you."
            },
            {
                "role": "user", 
                "content": "Add exclusions to exclude domain controllers with IPs 192.168.1.10 and 192.168.1.11, and exclude service accounts ending with $ from this rule"
            }
        ]
    }
} 